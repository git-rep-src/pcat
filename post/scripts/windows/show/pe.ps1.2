$ProgressPreference = "SilentlyContinue"
$OuputEncoding = [Text.UTF8Encoding]::UTF8
$global:BUF = ""
$RET = ""
$PSV = ([int]$PsVersionTable.PsVersion.Major) 
$TMP = ""
$CREDENTIAL_FILES = "\Panther\Unattended.xml", "\panther\setupinfo", "\system32\sysprep\Unattended.xml", "\system32\sysprep.inf" 
function xml()
{
    if ($args[0] -eq "OPEN") {
        $global:BUF += "<" + $args[1] + ">"
    } elseif ($args[0] -eq "CLOSE") {
        $global:BUF += "</" + $args[1] + ">"
    } else {
        $global:BUF += "<" + $args[0] + ">" + $args[1] + "</" + $args[0] + ">"
    }
}
if ($PSV -ne "" -and $PSV -ne $null -and $PSV -gt 2 -and $? -eq "True") {
    xml "OPEN" "SSH"
    $RET = (reg query HKEY_CURRENT_USER\Software\OpenSSH\Agent\Keys)
    if ($RET -ne "" -and $RET -ne $null -and $? -eq "True") {
        xml "KEYS" $RET
    } else {
        xml "KEYS" "No"
    }
    xml "CLOSE" "SSH"
    xml "OPEN" "CREDENTIALS"
    foreach ($FILE in $CREDENTIAL_FILES) {
        $RET = (Test-Path $Env:WINDIR$FILE)
        if ($RET -ne "" -and $RET -ne $null -and $? -eq "True") {
            $TMP += "$Env:WINDIR$FILE"+": Yes`n" 
        } else {
            $TMP += "$Env:WINDIR$FILE"+": No`n"
        }
    }
    xml "NONE" $TMP
    xml "CLOSE" "CREDENTIALS"
} else {
    xml "OPEN" "NULL"
    xml "NONE" "Powershell is not installed or version is not compatible"
    xml "CLOSE" "NULL"
}
xml "CLOSE" "DATA"
echo "$BUF [POST-EOS]"
